/* ============================================
   OPTIMIZACIONES MÓVIL
   ============================================ */

/* Asegurar tamaños táctiles mínimos de 44x44px */
@media (max-width: 768px) {

  /* Hero FG: mantener el personaje dentro del contenedor en móviles */
  .heroSceneLayer--fg {
    inset: 0;
    background-size: contain;
    background-position: 50% 100%;
  }

  /* BOTONES principales - Tamaño mínimo para tocar fácilmente */
  .pill,
  .bottomNav__btn {
    min-height: 44px;
    min-width: 44px;
    padding: 12px 20px;
    font-size: 16px;
  }

  .pill--small {
    min-height: 40px;
    padding: 10px 16px;
    font-size: 15px;
  }

  /* INPUTS - Evitar zoom en iOS */
  input,
  textarea,
  select {
    font-size: 16px !important;
    min-height: 44px;
    padding: 12px;
  }

  textarea {
    min-height: 100px;
  }

  /* Excepción: los textareas del overlay de notas sobre la imagen del héroe
     son compactos por diseño; no deben crecer al tamaño genérico táctil */
  .heroNotesOverlay textarea,
  .noteGrid--overlay textarea {
    min-height: unset;
  }

  /* TEXTOS - Más grandes para legibilidad */
  .heroCard__name {
    font-size: 18px !important;
  }

  .heroCard__level {
    font-size: 28px !important;
  }

  .challengeItem__title {
    font-size: 17px !important;
    line-height: 1.4;
  }

  .challengeItem__subtitle {
    font-size: 14px !important;
  }

  .statBadge {
    font-size: 15px !important;
    padding: 6px 10px !important;
  }

  /* Medallas: mantener escala consistente con el resto del formulario */
  #heroMedalsCount {
    font-size: 15px !important;
    font-weight: 900;
  }

  /* XP BAR - Más grande */
  .xpBar {
    height: 12px !important;
    border-radius: 12px;
  }

  /* CARDS - Más espacio */
  .heroCard {
    padding: 20px;
    margin-bottom: 16px;
  }

  .card {
    padding: 20px;
  }

  /* CHALLENGES LIST - Mejor espaciado */
  .challengeItem {
    padding: 16px !important;
    margin-bottom: 12px !important;
  }

  /* MODALS - Pantalla completa en móvil pequeño */
  @media (max-width: 480px) {
    .modal__card {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      border-radius: 0 !important;
    }
    /* Event modal: el grid ocupa todo el alto */
    .modal__card--event .eventModalGrid{
      min-height: 100vh;
      min-height: 100dvh;
    }
    .modal__card--event .eventModalImgWrap{
      border-radius: 0;
    }
  }

  /* STATS - Indicadores más grandes */
  .statRange {
    display: none; /* Ocultar completamente en mobile; se usan los clics en segmentos */
  }

  .statSeg {
    min-width: 8px;
  }

  /* BADGES - Más visibles */
  .badge {
    font-size: 14px !important;
    padding: 6px 12px !important;
  }

  .badge--mini {
    font-size: 13px !important;
    padding: 4px 10px !important;
  }

  /* PILLS GROUP - Espaciado para dedos */
  .diffPills {
    gap: 12px !important;
  }

  .diffPills .pill {
    flex: 1;
    min-width: 0;
  }

  /* EVENT CARDS (maqueta) - 2 columnas cuando haya espacio; 1 columna en pantallas muy chicas */
  .gridCards--events{
    grid-template-columns: repeat(2, minmax(150px, 1fr)) !important;
    gap: 14px !important;
  }
  @media (max-width: 380px){
    .gridCards--events{ grid-template-columns: 1fr !important; }
  }

  /* HERO DETAIL - Mejor layout */
  .heroDetail {
    gap: 16px;
  }

  .heroDetail__section {
    padding: 16px;
  }

  /* FLOATING ACTION BUTTONS - Más grandes */
  .fab {
    width: 56px !important;
    height: 56px !important;
    font-size: 24px !important;
  }

  /* TOAST NOTIFICATIONS - Más legibles */
  .toast {
    font-size: 16px !important;
    padding: 16px 24px !important;
    min-height: 52px;
    border-radius: 12px;
  }

  /* NAVIGATION - Mejor accesibilidad táctil */
  .bottomNav {
    min-height: 60px;
    /* No fixed height: let safe-area padding expand the bar on notched iPhones */
  }

  .bottomNav__btn {
    font-size: 15px;
    padding: 8px 12px;
  }

  /* HEADERS - Más legibles */
  .h2 {
    font-size: 28px !important;
  }

  .h3 {
    font-size: 22px !important;
  }

  .pageIntro {
    padding: 20px;
  }

  /* DROPDOWN MENUS - Mejor espaciado */
  .dropdown__menu {
    max-height: 60vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .dropdown__item {
    padding: 14px 16px !important;
    font-size: 16px !important;
  }

  /* FORMS - Mejor UX */
  .field {
    margin-bottom: 20px;
  }

  .label {
    font-size: 15px !important;
    margin-bottom: 8px;
    font-weight: 600;
  }

  /* REWARDS LIST - Más espacio entre items */
  .rewardsList {
    gap: 12px;
  }

  .rewardItem {
    padding: 14px;
  }

  /* STATS SELECTOR - Más fácil de tocar */
  #statsBox .statRow {
    margin-bottom: 16px;
  }

  .statLabel {
    font-size: 15px !important;
  }

  /* CHALLENGE CHIPS - Más grandes */
  .chProgressChips {
    gap: 8px;
  }

  .chChip {
    min-width: 44px;
    min-height: 32px;
    font-size: 14px;
  }

  /* PHOTO BOX - Área de toque clara */
  .photoBox {
    min-height: 200px;
  }

  /* SAFE AREA para iPhones con notch */
  @supports (padding: max(0px)) {
    body {
      padding-top: max(0px, env(safe-area-inset-top));
      padding-bottom: max(0px, env(safe-area-inset-bottom));
    }

    .bottomNav {
      padding-bottom: max(8px, env(safe-area-inset-bottom));
    }
  }

  /* LANDSCAPE MODE - Ajustes */
  @media (orientation: landscape) and (max-height: 500px) {
    .luStage {
      height: 150px !important;
    }

    .luBadge {
      width: 80px !important;
      height: 80px !important;
    }

    .luNum {
      font-size: 40px !important;
    }

    .luKicker {
      font-size: 16px !important;
    }
  }
}

/* EXTRA SMALL SCREENS (iPhone SE, etc) */
@media (max-width: 375px) {
  .pill {
    font-size: 15px;
    padding: 10px 16px;
  }

  .heroCard__name {
    font-size: 16px !important;
  }

  .challengeItem__title {
    font-size: 16px !important;
  }

  .h2 {
    font-size: 24px !important;
  }

  .h3 {
    font-size: 20px !important;
  }
}

/* PREVENIR ZOOM ACCIDENTAL en inputs */
@media (max-width: 768px) {
  input:focus,
  textarea:focus,
  select:focus {
    font-size: 16px !important;
  }
}

/* SCROLL SUAVE EN MÓVIL */
@media (max-width: 768px) {
  .pages,
  .dropdown__menu,
  .modal__card,
  .eventModalInfo,
  .eventModalGrid {
    -webkit-overflow-scrolling: touch;
  }

  body {
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
  }
}

/* CONTRASTE MEJORADO EN MÓVIL */
@media (max-width: 768px) {
  .muted {
    opacity: 0.8;
  }

  /* Bordes más visibles */
  .card,
  .modal__card {
    border-width: 2px;
  }
}


/* ============================================
   iPhone 12 Pro / phones ≤430px
   ============================================ */

/* --- HEADER: hamburger icon alignment fix --- */
@media (max-width: 430px) {
  /* Hamburger button: centered icon */
  .iconbtn,
  .topbar__menu {
    display: grid !important;
    place-items: center !important;
    padding: 0 !important;
    min-height: auto !important;
    min-width: auto !important;
    width: 40px !important;
    height: 40px !important;
    font-size: 20px !important;
    line-height: 1 !important;
  }

  #btnMenu {
    transform: none !important;
  }

  .topbar__trophyBtn {
    display: grid !important;
    place-items: center !important;
    padding: 0 !important;
    min-height: auto !important;
    min-width: auto !important;
    width: 40px !important;
    height: 40px !important;
  }

  .trophyIcon {
    width: 20px !important;
    height: 20px !important;
  }

  /* Topbar: compacta */
  .topbar {
    min-height: 50px !important;
    padding: 4px 8px !important;
    border-radius: 16px !important;
  }

  .brand__logoImg {
    width: 42px !important;
    height: 42px !important;
  }
}


/* --- FICHAS: Hero scene + formulario --- */
@media (max-width: 430px) {
  /* Hero scene: más compacta en celular para evitar que la foto domine toda la ficha */
  .heroScene {
    height: auto;
    aspect-ratio: 4 / 5;
    min-height: clamp(250px, 40svh, 340px);
    max-height: min(58svh, 440px);
  }

  /* FG layer: contain to show full character, anchored at bottom-center */
  .heroSceneLayer--fg {
    inset: 0;
    background-size: contain;
    background-position: 50% 100%;
  }

  /* BG/MID más grandes para que el parallax no recorte la escena */
  .heroSceneLayer--bg {
    inset: -14%;
    background-size: cover;
    background-position: 50% 52%;
  }

  .heroSceneLayer--mid {
    inset: -10%;
    background-position: 50% 68%;
  }

  /* Nombre overlay: compacto */
  .heroName--overlay {
    font-size: 18px !important;
    letter-spacing: 3px !important;
    top: 10px !important;
    left: 12px !important;
  }

  /* cardGrid en columna */
  .cardGrid {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }

  .content {
    padding: 6px !important;
  }

  /* Avatar card: remove padding so heroScene fills the card edge-to-edge */
  .card--avatar {
    padding: 0 !important;
    border-radius: 16px !important;
    overflow: hidden !important;
  }

  /* Card del formulario: compacta */
  .page[data-page="fichas"] .card:not(.card--avatar) {
    padding: 12px !important;
  }

  .fields3 {
    grid-template-columns: 1fr 80px !important;
    gap: 10px !important;
    margin-bottom: 6px !important;
  }

  /* Override 640px rule so Medallas shares the row with Rol (2×2 grid) */
  .fields3 .field:last-child {
    grid-column: auto !important;
  }

  .field {
    margin-bottom: 10px !important;
  }

  .field--medals {
    margin-bottom: 4px !important;
  }

  .medalBadgeSmall {
    height: 40px !important;
    padding: 0 10px !important;
    gap: 8px !important;
    font-size: 14px !important;
  }

  .medalBadgeSmall .medalCount {
    font-size: 14px !important;
  }

  .medalBadgeSmall .medalSvg {
    width: 18px !important;
    height: 18px !important;
  }

  /* Stats: contained within parent — visible stat values use the 30px grid column */
  .stats {
    margin-bottom: 6px !important;
    padding: 8px !important;
    overflow: hidden !important;
  }

  .stat {
    grid-template-columns: 40px minmax(0, 1fr) 30px !important;
    gap: 6px !important;
    padding: 5px 0 !important;
  }

  .stat__val,
  .statNum {
    font-size: 15px !important;
    transform: none !important;
    -webkit-text-stroke: 0 !important;
    min-width: 28px !important;
    overflow: visible !important;
  }

  .badge {
    width: 36px !important;
    height: 24px !important;
    font-size: 10px !important;
    padding: 2px 4px !important;
  }

  /* XP section: compacta */
  .xpHeader {
    margin-top: 10px !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
  }

  .xpBtns {
    gap: 4px !important;
  }

  .xpBtns .pill--small,
  .xpBtns .pill--ghost {
    padding: 6px 8px !important;
    font-size: 12px !important;
    min-height: 32px !important;
    min-width: 0 !important;
  }

  .xpCard {
    padding: 8px !important;
  }

  .xpFooter {
    gap: 6px !important;
  }

  /* Notas overlay: compactas */
  .heroNotesOverlay {
    max-height: 24% !important;
  }

  .heroNotesOverlay .noteGrid--overlay {
    gap: 6px !important;
  }

  .heroNotesOverlay .textarea--short {
    min-height: 36px !important;
    max-height: 60px !important;
    font-size: 13px !important;
  }
}

/* --- EXTRA SMALL PHONES (SE / Android compactos) --- */
@media (max-width: 360px) {
  .heroScene {
    height: max(250px, 40svh) !important;
    max-height: 52svh !important;
  }

  /* Reduce fricción: formulario en una sola columna */
  .fields3 {
    grid-template-columns: 1fr !important;
  }

  .fields3 .field:last-child {
    grid-column: auto !important;
  }

  .xpBtns {
    width: 100%;
  }

  .xpBtns .pill--small,
  .xpBtns .pill--ghost {
    flex: 1 1 calc(50% - 4px) !important;
  }
}


/* --- DESAFÍOS: jerarquía visual de botones --- */
@media (max-width: 430px) {
  /* challengeTop: layout compacto con jerarquía visual */
  .challengeTop {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    padding: 0 !important;
    margin: 4px 0 10px !important;
  }

  /* Dropdown de materia: más destaque como filtro principal */
  .challengeTop .dropdown .pill {
    font-size: 13px !important;
    padding: 8px 14px !important;
    min-height: 36px !important;
    min-width: 0 !important;
    border-color: rgba(34, 211, 238, 0.45) !important;
    background: rgba(34, 211, 238, 0.08) !important;
  }

  /* Dificultad: row compacta, aspecto "segmented control" */
  .diffPills {
    display: flex !important;
    gap: 0 !important;
    width: 100% !important;
    order: 1 !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    border: 1px solid rgba(255, 255, 255, 0.12) !important;
  }

  .diffPills .pill {
    flex: 1 !important;
    border-radius: 0 !important;
    border: none !important;
    border-right: 1px solid rgba(255, 255, 255, 0.08) !important;
    padding: 8px 4px !important;
    font-size: 12px !important;
    min-height: 34px !important;
    min-width: 0 !important;
    background: rgba(255, 255, 255, 0.03) !important;
    text-align: center !important;
    justify-content: center !important;
  }

  .diffPills .pill:last-child {
    border-right: none !important;
  }

  .diffPills .pill.is-active {
    background: rgba(34, 211, 238, 0.14) !important;
  }

  /* Botones secundarios (admin): más discretos */
  #btnAddChallenge,
  #btnManageSubjects,
  #btnHistory {
    font-size: 12px !important;
    padding: 6px 10px !important;
    min-height: 32px !important;
    min-width: 0 !important;
    opacity: 0.85 !important;
  }

  /* Admin buttons: fila compacta, orden al final */
  #btnAddChallenge {
    order: 2 !important;
  }
  #btnManageSubjects {
    order: 3 !important;
  }
  #btnHistory {
    order: 4 !important;
  }

  /* Challenge items: edit/delete buttons inline */
  .challengeItem {
    position: relative !important;
    padding: 12px !important;
  }

  html.is-edit .chItemActions {
    position: static !important;
    transform: none !important;
    display: flex !important;
    margin-bottom: 6px !important;
    justify-content: flex-start !important;
    gap: 6px !important;
  }

  .challengeName {
    font-size: 15px !important;
    line-height: 1.3 !important;
    word-break: break-word !important;
  }

  .challengeMetaRow {
    gap: 6px !important;
  }

  .chPill {
    padding: 4px 8px !important;
    font-size: 11px !important;
    min-height: auto !important;
    min-width: auto !important;
  }

  /* Desafíos cards: stack vertical */
  .cards2--ch {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }

  /* Card head del bloque Desafíos */
  .cardHead--ch {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 6px !important;
  }

  .chProgressChips {
    width: 100% !important;
  }

  /* Challenge detail: más compacto */
  .challengeDetailHead {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 6px !important;
  }

  .challengeBody {
    min-height: 100px !important;
    font-size: 14px !important;
    padding: 10px !important;
  }
}


/* --- TIENDA: ocultar título redundante, fix admin buttons --- */
@media (max-width: 430px) {
  /* Ocultar título "Tienda" y subtítulo: el tab ya indica la sección */
  .page[data-page="tienda"] > .pageIntro {
    display: none !important;
  }

  /* Grid: una columna */
  .tiendaGrid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }

  /* Tienda items: layout vertical, nada se corta */
  .tiendaItem {
    flex-direction: column !important;
    padding: 14px !important;
    overflow: visible !important;
  }

  .tiendaItem__icon {
    width: 50px !important;
    height: 50px !important;
    font-size: 32px !important;
    align-self: flex-start !important;
  }

  .tiendaItem__body {
    width: 100% !important;
  }

  .tiendaItem__name {
    font-size: 15px !important;
    word-break: break-word !important;
  }

  .tiendaItem__desc {
    font-size: 13px !important;
  }

  .tiendaItem__footer {
    flex-wrap: wrap !important;
    gap: 8px !important;
  }

  .tiendaItem__claimBtn {
    position: static !important;
    width: 100% !important;
    margin-top: 8px !important;
  }

  /* Admin buttons: siempre visibles (no hover), posición estática */
  .tiendaItem__adminBtns {
    position: static !important;
    opacity: 1 !important;
    display: flex !important;
    margin-top: 8px !important;
    justify-content: flex-start !important;
    gap: 8px !important;
  }

  /* Tienda header: compacto */
  .tiendaHeader {
    padding: 12px !important;
    gap: 10px !important;
  }

  .medalBadgeLarge {
    padding: 8px 14px !important;
    gap: 8px !important;
  }

  .medalBadgeLarge .medalCount {
    font-size: 22px !important;
  }
}


/* --- EVENTOS: cards y modal --- */
@media (max-width: 430px) {
  .gridCards--events {
    grid-template-columns: repeat(2, minmax(140px, 1fr)) !important;
    gap: 10px !important;
  }

  .evCard {
    padding: 8px !important;
    gap: 8px !important;
    border-radius: 16px !important;
  }

  .evCard__media {
    border-radius: 12px !important;
  }

  .evCard__title {
    font-size: clamp(12px, 3.2vw, 16px) !important;
  }

  .evCard__titleOnArt {
    left: 8px !important;
    right: 8px !important;
    bottom: 8px !important;
  }

  .evCard__chev {
    width: 24px !important;
    height: 24px !important;
  }

  .evPill {
    height: 22px !important;
    padding: 0 8px !important;
    font-size: 10px !important;
  }

  .evCard__req {
    gap: 6px !important;
  }

  .evReqText {
    font-size: 11px !important;
  }

  .evReqIcon {
    width: 22px !important;
    height: 22px !important;
  }

  .pageIntro--events {
    padding: 8px 12px !important;
  }

  .eventTabs .pill {
    padding: 8px 14px !important;
    font-size: 13px !important;
  }
}

/* --- EVENTOS MODAL: fullscreen --- */
@media (max-width: 430px) {
  /* Remove parent padding so the fullscreen card reaches the viewport edges */
  #eventModal {
    padding: 0 !important;
  }

  /* Use ID selector to override the generic .modal__card rule that appears later */
  #eventModal .modal__card--event {
    width: 100% !important;
    height: 100% !important;
    max-width: none !important;
    max-height: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
  }

  .eventModalImgWrap {
    border-radius: 0 !important;
  }

  .eventModalGrid {
    min-height: 100% !important;
  }

  #btnEventClose.iconBtn {
    top: max(12px, env(safe-area-inset-top, 12px)) !important;
    right: 12px !important;
    width: 44px !important;
    height: 44px !important;
    min-height: auto !important;
    min-width: auto !important;
    padding: 0 !important;
  }

  .eventModalInfo {
    left: 10px !important;
    right: 10px !important;
    bottom: max(10px, env(safe-area-inset-bottom, 10px)) !important;
  }

  .eventModalReqGrid {
    grid-template-columns: 1fr !important;
    gap: 8px !important;
  }

  .eventModalReqBox {
    padding: 10px !important;
    border-radius: 12px !important;
  }

  .eventModalReqTitle {
    font-size: 11px !important;
  }

  .eventModalReqText {
    font-size: 12px !important;
  }

  .eventModalActions {
    gap: 8px !important;
    padding-top: 8px !important;
  }

  .eventModalActions .btn {
    flex: 1 !important;
    text-align: center !important;
    justify-content: center !important;
    font-size: 13px !important;
    padding: 10px 12px !important;
  }
}


/* --- BOTTOM NAV --- */
@media (max-width: 430px) {
  .bottomNav {
    gap: 6px !important;
    padding: 8px 8px calc(8px + env(safe-area-inset-bottom)) !important;
  }

  .bottomNav__btn {
    font-size: 13px !important;
    padding: 10px 6px !important;
    border-radius: 14px !important;
    min-width: 0 !important;
    min-height: auto !important;
  }

  .pages {
    /* Ensure content clears the bottom nav even on iPhones with home indicator (34px safe area).
       Nav height ≈ 54px content + env(safe-area-inset-bottom); add a 6px buffer. */
    padding-bottom: max(84px, calc(60px + env(safe-area-inset-bottom, 0px))) !important;
    /* Reset desktop scrollbar compensation — mobile scrollbars overlay, no gutter needed */
    padding-right: 0 !important;
    padding-left: 0 !important;
    scrollbar-gutter: auto !important;
  }
}


/* --- GENERAL: overflow + resets para teléfono --- */
@media (max-width: 430px) {
  /* Tighter app padding so content fills more of the screen */
  .app {
    padding-left: calc(4px + var(--safe-left)) !important;
    padding-right: calc(4px + var(--safe-right)) !important;
  }

  /* Prevent any horizontal overflow from leaking past the app shell */
  html, body, .app, .shell {
    overflow-x: hidden !important;
  }

  .page {
    overflow-x: hidden !important;
  }

  /* Cards: never wider than their container */
  .card, .cardGrid, .heroScene {
    max-width: 100% !important;
  }

  /* Modals genéricos: bottom sheet style — use % instead of vw to avoid scrollbar width issues */
  .modal__card {
    width: calc(100% - 16px) !important;
    max-height: 88vh !important;
    border-radius: 16px 16px 10px 10px !important;
    padding: 12px !important;
  }

  .modal__header {
    position: sticky !important;
    top: 0 !important;
    z-index: 2 !important;
    padding-bottom: 8px !important;
    margin-bottom: 6px !important;
  }

  /* Resetear min-height/min-width en botones inline que NO necesitan 44px */
  .chIconBtn,
  .iconBtn,
  .iconBtn--small,
  .iconBtn--tiny,
  .chPill,
  .pill--status,
  .iconbtn {
    min-height: auto !important;
    min-width: auto !important;
  }

  .chIconBtn {
    width: 32px !important;
    height: 32px !important;
    padding: 0 !important;
    display: grid !important;
    place-items: center !important;
  }
}

/* ============================================
   iPad mini 6 portrait y tabletas pequeñas (641–780px)
   El header usa flex en este rango pero el hamburger
   necesita tamaño explícito para no verse estirado
   ============================================ */
@media (min-width: 641px) and (max-width: 900px) {
  .topbar__menu {
    width: 42px;
    height: 42px;
    flex-shrink: 0;
    font-size: 20px;
    line-height: 1;
    border-radius: 12px;
  }
}

/* Hero detail en columna única para iPad mini portrait (744px cae aquí) */
@media (min-width: 641px) and (max-width: 780px) {
  .cardGrid {
    grid-template-columns: 1fr !important;
  }

  /* Stats: 2 columnas (las 5 stats caben cómodamente) */
  .stats {
    grid-template-columns: 1fr 1fr;
  }

  /* Fields3: 2 columnas en lugar de 3 */
  .fields3 {
    grid-template-columns: 1fr 80px;
  }

  /* El panel derecho ocupa el ancho completo */
  .card--form,
  .card--stats {
    width: 100%;
  }
}
